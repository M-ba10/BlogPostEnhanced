{% include "header.html" %}

<!-- Page Header with Rounded Corners -->
<header class="masthead rounded-bottom-4 rounded-top-4 overflow-hidden" style="background-image: url('../static/assets/img/home-bg.jpg')">
  <div class="container position-relative px-4 px-lg-5">
    <div class="row gx-4 gx-lg-5 justify-content-center">
      <div class="col-md-10 col-lg-8 col-xl-7">
        <div class="site-heading">
          <h1>
              {{ _("Welcome") }}
              {% if current_user.is_authenticated %}
                {{ current_user.name }}.
              {% else %}
                {{ _("Guest") }}.
              {% endif %}
          </h1>
          <span class="subheading">{{ _("A collection of random musings.") }}.</span>
        </div>
      </div>
    </div>
  </div>
</header>

<!-- Main Content-->
<div class="container px-4 px-lg-5">
  <div class="row gx-4 gx-lg-5 justify-content-center">
    <div class="col-md-10 col-lg-8 col-xl-7">
      {% for post in all_posts %}
      <div class="post-preview d-flex align-items-start mb-4">
        <div class="author-avatar me-3 position-relative">
          <img class="rounded-circle shadow-sm"
               src="{% if post.author.profile_image %}
                    {{ url_for('static', filename='profile_pics/' + post.author.profile_image) }}
                    {% else %}
                    {{ get_gravatar_url(post.author.email, 80) }}
                    {% endif %}"
               style="width: 80px; height: 80px; object-fit: cover;">
          <div class="author-badge">{{ post.author.name|first|upper }}</div>
        </div>
        <div class="post-content">
          <a href="{{ url_for('show_post', post_id=post.id) }}" class="text-decoration-none">
            <h2 class="post-title mb-1">{{ post.title }}</h2>
            <h3 class="post-subtitle text-muted mb-2">{{ post.subtitle }}</h3>
          </a>
          <div class="author-info d-flex align-items-center">
            <span class="author-name me-2">
              <i class="fas fa-user-circle me-1"></i>
              <span class="fw-semibold">{{ post.author.name }}</span>
            </span>
            <span class="post-date text-muted">
              <i class="far fa-calendar-alt me-1"></i>
              {{ post.date }}
            </span>
            {% if current_user.id == 1 %}
            <span class="ms-2">
              <a href="{{url_for('delete_post', post_id=post.id) }}" class="text-danger">
                <i class="fas fa-trash-alt"></i>
              </a>
            </span>
            {% endif %}
          </div>



        </div>
      </div>
      {% if not loop.last %}
      <hr class="my-4 opacity-25" />
      {% endif %}
      {% endfor %}

      <!-- New Post -->
      {% if current_user.id == 1: %}
      <div class="d-flex justify-content-end mb-4">
        <a class="btn btn-primary" href="{{url_for('add_new_post')}}">
          <i class="fas fa-plus me-1"></i>{{ _('Create New Post') }}
        </a>
      </div>
      {% endif %}

      <!-- Pager-->
      <div class="d-flex justify-content-end mb-4">
        <div id="global-weather-display" class="mt-3" style="display:none;"></div>
      </div>
    </div>

      <!-- Weather Widget (updated) -->
      <div class="col-lg-4 d-none d-lg-block">
        <div class="card mb-4 shadow-sm border-0">
          <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="fas fa-temperature-high me-2"></i> {{ _("Local Weather") }}</h5>
            <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#weatherModal">
              <i class="fas fa-edit"></i>
            </button>
          </div>
          <div class="card-body text-center">
            <div id="sidebar-weather">
              <div class="spinner-border text-primary" role="status"></div>
            </div>
            <small class="text-muted" id="weather-location">Detecting your location...</small>
            <div class="mt-2">
              <a href="#" id="use-current-location" class="small text-primary">
                <i class="fas fa-location-arrow"></i> Use my current location
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- Add this modal at the bottom of your template -->
  <!-- Weather Modal (updated) -->
  <div class="modal fade" id="weatherModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Change Weather Location</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="weatherForm">
            <div class="mb-3">

              <label class="form-label">City Name</label>
              <input type="text" class="form-control mb-3" id="weatherCity" placeholder="e.g. Paris, Tokyo">

              <button type="submit" form="weatherForm" class="btn btn-primary me-2">Update</button>
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>


            </div>
          </form>
        </div>

        <!-- <div class="modal-footer">
          <button type="button" id="detect-location" class="btn btn-outline-primary me-auto">
            <i class="fas fa-location-arrow"></i> Detect Location
          </button>
        </div> -->

      </div>
    </div>
  </div>


</div>

<style>
  .masthead {
    border-bottom-left-radius: 1.5rem !important;
    border-bottom-right-radius: 1.5rem !important;
    overflow: hidden;
  }

  .author-avatar {
    position: relative;
    flex-shrink: 0;
  }

  .author-badge {
    position: absolute;
    bottom: -5px;
    right: -5px;
    width: 30px;
    height: 30px;
    background-color: #3498db;
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 0.9rem;
    border: 2px solid white;
  }

  .author-info {
    font-size: 0.9rem;
  }

  .author-name {
    color: #2c3e50;
  }

  .post-title {
    font-size: 1.5rem;
    color: #2c3e50;
    transition: color 0.2s;
  }

  .post-title:hover {
    color: #3498db;
  }

  .post-subtitle {
    font-size: 1.1rem;
  }

  /* Tags styling */
  .tag-pill {
    display: inline-block;
    padding: 0.35rem 0.75rem;
    margin: 0.25rem;
    background-color: #f8f9fa;
    border-radius: 50px;
    color: #495057;
    text-decoration: none;
    transition: all 0.3s ease;
    border: 1px solid #e9ecef;
    font-size: 0.85rem;
  }

  .tag-pill:hover {
    background-color: #2c3e50;
    color: white !important;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  }

  .tags-cloud {
    display: flex;
    flex-wrap: wrap;
  }

  /* Tag size variations */
  .tag-size-1 { font-size: 0.8em; }
  .tag-size-2 { font-size: 0.9em; }
  .tag-size-3 { font-size: 1.0em; }
  .tag-size-4 { font-size: 1.1em; }
  .tag-size-5 { font-size: 1.2em; }

  @media (max-width: 768px) {
    .masthead {
      border-bottom-left-radius: 1rem !important;
      border-bottom-right-radius: 1rem !important;
    }

    .author-avatar img {
      width: 60px;
      height: 60px;
    }

    .post-title {
      font-size: 1.3rem;
    }

    .post-subtitle {
      font-size: 1rem;
    }
  }

  /* Hide sidebar on mobile */
    .col-lg-4 {
      display: none;
    }
  }

  @media (min-width: 992px) {
    /* Adjust main content width when sidebar is visible */
    .col-lg-8 {
      flex: 0 0 66.666667%;
      max-width: 66.666667%;
    }
  }

  /* Weather specific styles */
    .weather-toggle {
      transition: all 0.3s ease;
    }

    .weather-display {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      border-radius: 8px;
      padding: 12px;
      border-left: 3px solid #0dcaf0;
    }

    .weather-btn:hover {
      background-color: #0dcaf0;
      color: white;
    }

    #sidebar-weather img {
      height: 60px;
      margin: -10px 0;
    }

    #global-weather-display {
      background: linear-gradient(135deg, #f8f9fa 0%, #dfe7f1 100%);
      border-radius: 10px;
      padding: 15px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

    /* Add to your existing styles */
    #weatherModal .modal-dialog {
        max-width: 400px;
    }



    /* Weather details styling */
    .weather-details {
        font-size: 0.85rem;
        opacity: 0.8;
    }

    .weather-details span {
        display: inline-block;
        margin-right: 10px;
    }

    #use-current-location {
    text-decoration: none;
    transition: all 0.2s;
  }

  #use-current-location:hover {
    text-decoration: underline;
  }

  .weather-source-badge {
    font-size: 0.7rem;
    padding: 0.2rem 0.4rem;
    background: #e9ecef;
    border-radius: 4px;
    margin-left: 0.5rem;
  }


</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let isLoading = false;
    let currentController = null;

    // 1. Shared weather display funct
    function displayWeather(container, weather, source = 'manual') {
        if (!container) return;

        if (weather.error) {
            container.innerHTML = `<div class="alert alert-warning">${weather.error}</div>`;
            return;
        }

        container.innerHTML = `
            <div class="d-flex justify-content-center align-items-center">
                <img src="https://openweathermap.org/img/wn/${weather.icon}@2x.png"
                     alt="${weather.description}" style="height: 60px">
                <div class="ms-3">
                    <span class="h4">${Math.round(weather.temp)}Â°C</span>
                    <div class="text-capitalize small">${weather.description}</div>
                </div>
            </div>
            <div class="row mt-2 small text-muted">
                <div class="col-6">Humidity: ${weather.humidity}%</div>
                <div class="col-6">Wind: ${weather.wind_speed} m/s</div>
            </div>
            ${source === 'geo' ?
              '<div class="text-end mt-2"><span class="weather-source-badge">Auto-detected</span></div>' : ''}
        `;

        const locationEl = document.getElementById('weather-location');
        if (locationEl) {
            locationEl.textContent = `${weather.city}${weather.country ? ', ' + weather.country : ''}`;
        }
    }

    // 2. Geolocation functions with better error handling
    async function getCurrentPosition() {
        return new Promise((resolve, reject) => {
            if (!navigator.geolocation) {
                reject(new Error('Geolocation not supported'));
                return;
            }

            navigator.geolocation.getCurrentPosition(
                resolve,
                error => {
                    console.error('Geolocation error:', error);
                    reject(new Error('Could not get your location'));
                },
                {
                    enableHighAccuracy: false,
                    timeout: 5000,
                    maximumAge: 15 * 60 * 1000 // 15 minutes cache
                }
            );
        });
    }

    // 3. Fetch functions with abort controller and timeout
    async function fetchWeatherByCoords(lat, lon) {
        if (currentController) {
            currentController.abort();
        }

        currentController = new AbortController();
        const timeoutId = setTimeout(() => currentController.abort(), 8000);

        try {
            const response = await fetch(`/api/weather?lat=${lat}&lon=${lon}`, {
                signal: currentController.signal
            });

            clearTimeout(timeoutId);

            if (!response.ok) throw new Error('Network error');
            const data = await response.json();
            return {...data, source: 'geo'};
        } catch (error) {
            clearTimeout(timeoutId);
            console.error('Weather fetch error:', error);
            return {error: error.name === 'AbortError' ? 'Request timed out' : 'Failed to get weather for your location'};
        } finally {
            currentController = null;
        }
    }

    async function fetchWeatherByCity(city = null) {
        if (currentController) {
            currentController.abort();
        }

        currentController = new AbortController();
        const timeoutId = setTimeout(() => currentController.abort(), 8000);

        try {
            const url = city ? `/api/weather?city=${encodeURIComponent(city)}` : '/api/weather';
            const response = await fetch(url, {
                signal: currentController.signal
            });

            clearTimeout(timeoutId);

            if (!response.ok) throw new Error('Network error');
            return await response.json();
        } catch (error) {
            clearTimeout(timeoutId);
            console.error('Weather fetch error:', error);
            return {error: error.name === 'AbortError' ? 'Request timed out' : 'Failed to get weather data'};
        } finally {
            currentController = null;
        }
    }

    // 4. Main weather loading function with loading state
    async function loadWeather(preferredCity = null) {
        if (isLoading) return;
        isLoading = true;

        const sidebar = document.getElementById('sidebar-weather');
        const globalDisplay = document.getElementById('global-weather-display');

        // Show loading state
        if (sidebar) sidebar.innerHTML = '<div class="spinner-border text-primary" role="status"></div>';
        if (globalDisplay && globalDisplay.style.display !== 'none') {
            globalDisplay.innerHTML = '<div class="text-center py-3"><div class="spinner-border"></div></div>';
        }

        try {
            let weather;

            // Priority 1: Use preferred city if specified
            if (preferredCity) {
                weather = await fetchWeatherByCity(preferredCity);
            }
            // Priority 2: Try geolocation if no city specified
            else if (navigator.geolocation) {
                try {
                    const position = await getCurrentPosition();
                    weather = await fetchWeatherByCoords(position.coords.latitude, position.coords.longitude);

                    // Fallback to default if geolocation fails
                    if (weather.error) {
                        weather = await fetchWeatherByCity();
                    }
                } catch (geoError) {
                    console.log('Geolocation failed, using default:', geoError);
                    weather = await fetchWeatherByCity();
                }
            }
            // Priority 3: Fallback to default
            else {
                weather = await fetchWeatherByCity();
            }

            // Update displays
            if (sidebar) displayWeather(sidebar, weather, weather.source);
            if (globalDisplay && globalDisplay.style.display !== 'none') {
                displayWeather(globalDisplay, weather, weather.source);
            }

            return weather;
        } catch (error) {
            console.error('Weather load error:', error);
            return {error: 'Failed to load weather data'};
        } finally {
            isLoading = false;
        }
    }

    // 5. Event listeners with proper cleanup
    document.getElementById('use-current-location')?.addEventListener('click', async function(e) {
        e.preventDefault();
        await loadWeather();
    });

    document.getElementById('detect-location')?.addEventListener('click', async function() {
        const button = this;
        const originalText = button.innerHTML;

        try {
            button.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Detecting...';
            button.disabled = true;

            const position = await getCurrentPosition();
            const weather = await fetchWeatherByCoords(position.coords.latitude, position.coords.longitude);

            const sidebar = document.getElementById('sidebar-weather');
            if (sidebar) displayWeather(sidebar, weather, 'geo');

            const modal = bootstrap.Modal.getInstance(document.getElementById('weatherModal'));
            if (modal) modal.hide();
        } catch (error) {
            alert(error.message || 'Could not detect your location');
        } finally {
            button.innerHTML = originalText;
            button.disabled = false;
        }
    });

    document.getElementById('weatherForm')?.addEventListener('submit', async function(e) {
        e.preventDefault();
        if (isLoading) return;

        const cityInput = document.getElementById('weatherCity');
        const submitBtn = this.querySelector('button[type="submit"]');

        if (!cityInput || !submitBtn) return;

        const city = cityInput.value.trim();
        if (!city) return;

        isLoading = true;
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Updating...';
        submitBtn.disabled = true;

        try {
            const weather = await fetchWeatherByCity(city);

            const sidebar = document.getElementById('sidebar-weather');
            if (sidebar) displayWeather(sidebar, weather);

            const modal = bootstrap.Modal.getInstance(document.getElementById('weatherModal'));
            if (modal) modal.hide();

            cityInput.value = '';
        } catch (error) {
            console.error('Update failed:', error);
            alert('Failed to update weather location. Please try again.');
        } finally {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
            isLoading = false;
        }
    });

    // 6. Modal cleanup handler
    const weatherModal = document.getElementById('weatherModal');
    if (weatherModal) {
        weatherModal.addEventListener('hidden.bs.modal', function() {
            if (currentController) {
                currentController.abort();
                currentController = null;
            }
            document.getElementById('weatherCity').value = '';
        });
    }

    // 7. Initialize weather on page load
    (async function init() {
        await loadWeather();
    })();

});
</script>
{% include "footer.html" %}